<!DOCTYPE html>
<html lang="en">
  <title> </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="vendor/tachyons.css">
  <body>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ramda/0.23.0/ramda.min.js"></script>
        <script src="https://unpkg.com/mithril/mithril.js"></script>
        <script src="https://unpkg.com/mithril-stream"></script>
         <script src="vendor/paths.js"></script>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.3/chroma.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.7.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.7.1/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.7.1/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.7.1/firebase-messaging.js"></script>
        <script src="vendor/papa.js"></script>


        <script>

          var stream = window.m.stream
        
            /// Firebase and Variable Calculation
             var config = {
                    apiKey: "AIzaSyD_UYUYEG2DIfdw18YTrMsda0GhImCsMN4",
                    authDomain: "odisha-dash.firebaseapp.com",
                    databaseURL: "https://odisha-dash.firebaseio.com",
                    storageBucket: "odisha-dash.appspot.com",
                    messagingSenderId: "534292583836"
                };
            firebase.initializeApp(config);

            //stub for selecting district
            var selectedDistrict = stream("kandhamal")
            var selectedTahasil = stream("washington")
           

            //all data - use listRevenueData for further transformations
            var rawRevenueData = stream();
            var listRevenueData = rawRevenueData.map(function(value){
                return R.values(value)
            });

            var rawFraData = stream();
            var listFraData = rawFraData.map(function(value){
                return R.values(value)
            })

            //helpers
            var isInDistrict = R.propEq('district')
            var isInTahasil = R.propEq('tahasil')
            var isInCircle = R.propEq('circle')
            var isInBlock = R.propEq('block')

            var defaultToZero = R.defaultTo(0)

            var takeHouseholds = R.compose(defaultToZero, R.prop('households identified'))
            var sumHouseholds = R.compose(R.sum, R.map(takeHouseholds))
            var takePattas = R.compose(defaultToZero,R.prop('pattas distributed'))
            var sumPattas = R.compose(R.sum, R.map(takePattas))
            var takeWomenPattas = R.compose(defaultToZero, R.prop('pattas with women'))
            var sumWomenPattas = R.compose(R.sum, R.map(takeWomenPattas))
            var takeSubmitted = R.compose(defaultToZero, R.prop('claims submitted'))
            var sumSubmitted = R.compose(R.sum, R.map(takeSubmitted))
            var takeSettled = R.compose(defaultToZero, R.prop('claims settled'))
            var sumSettled = R.compose(R.sum, R.map(takeSettled))


            function classSafe(string){
                return string.replace(".","*").replace(" ","-")
            }

            function classUnsafe(string){
                return string.replace("*",".").replace("-"," ")
            }
            
            var firebaseSafe = function(string){
               return string.replace(".","~")
            }

           

            //District Helpers
            var allInDistrict = stream([]);
            allInDistrict = stream.combine(function(data, selected){
                var isInSelected = isInDistrict(selected());
                return R.filter(isInSelected, data());
            },[listRevenueData, selectedDistrict]);

            var allInFraDistrict = stream([]);
            allInFraDistrict = stream.combine(function(data, selected){
                var isInSelected = isInDistrict(selected());
                return R.filter(isInSelected, data());
            },[listFraData, selectedDistrict]);
            
           var totalHouseholds = allInDistrict.map(function(value){
               return sumHouseholds(value)
           })

           var totalPattas = allInDistrict.map(function(value){
               return sumPattas(value)
           })

           var totalWomenPattas = allInDistrict.map(function(value){
               return sumWomenPattas(value)
           })

           var totalSubmitted = allInFraDistrict.map(function(value){
                return sumSubmitted(value)
           })
           
           var totalSettled = allInFraDistrict.map(function(value){
                return sumSettled(value)
           })

            //State Helpers
            var stateData = listRevenueData.map(function(value){
                return {
                    "households": sumHouseholds(value),
                    "pattas": sumPattas(value),
                    "women": sumWomenPattas(value)
               }
            })
            
            var stateFraData = listFraData.map(function(value){
                return {
                    "submitted": sumSubmitted(value),
                    "settled":sumSettled(value)
                }
            })

            var allDistricts = listRevenueData.map(function(value){
               var takeDistricts = R.map(R.prop('district'))
               var defaultToList = R.defaultTo([])
               var uniqueDistricts = R.compose(R.uniq, takeDistricts)
               List["districts"].items = uniqueDistricts(value) 
               return uniqueDistricts(value)
           })

           var allFraDistricts =listFraData.map(function(value){
               var takeDistricts = R.map(R.prop('district'))
               var defaultToList = R.defaultTo([])
               var uniqueDistricts = R.compose(R.uniq, takeDistricts)
               List["fra_districts"].items = uniqueDistricts(value)
               return uniqueDistricts(value)
           })

            var districtData = function(district){
               var all = listRevenueData()
               var isInSelected = isInDistrict(district)
               var filtered = R.filter(isInSelected, all)
               //let fra = listFraData()
               //let isInFra = R.filter(isInSelected,fra)
              
               return  {
                    "district": district,
                    "households": sumHouseholds(filtered),
                    "pattas": sumPattas(filtered),
                    "women": sumWomenPattas(filtered)
               }
               
           }
            var fraDistrictData = function(district){
               var all = listFraData()
               var isInSelected = isInDistrict(district)
               var filtered = R.filter(isInSelected, all)
               //let fra = listFraData()
               //let isInFra = R.filter(isInSelected,fra)
              
               return  {
                    "district": district,
                    "submitted": sumSubmitted(filtered),
                    "settled": sumSettled(filtered),
               }
               
           }
        
           //TahasilHelpers
           var tahasilsInDistrict = allInDistrict.map(function(value){
               var takeTahasils = R.map(R.prop('tahasil'))
               var defaultToList = R.defaultTo([])
               var uniqueTahasils = R.compose(R.uniq, takeTahasils)
               List["tahasils"].items = uniqueTahasils(value)
               return uniqueTahasils(value)
           })

           var tahasilData = function(tahasil){
               var district = allInDistrict()
               var isInSelected = isInTahasil(tahasil)
               var filtered = R.filter(isInSelected, district)
               return {
                    "tahasil": tahasil,
                    "households": sumHouseholds(filtered),
                    "pattas": sumPattas(filtered),
                    "women": sumWomenPattas(filtered)
               }
           }
           
            var allInTahasil = stream([]);
            allInTahasil = stream.combine(function(data, tahasil){
                var isInSelected = isInTahasil(tahasil())
                var filtered = R.filter(isInSelected, tahasil())
                return R.filter(isInSelected, data());
           },[allInDistrict, selectedTahasil]);

           var circlesInTahasil = allInTahasil.map(function(value){
               var takeCircles = R.map(R.prop('circle'))
               var defaultToList = R.defaultTo([])
               var uniqueCircles = R.compose(R.uniq, takeCircles)
               List["circles"].items = uniqueCircles(value)
               return uniqueCircles(value)
           })
           
            var circleData = function(circle){
               var tahasil = allInTahasil()
               var selected = R.find(isInCircle(circle), tahasil)
               return {
                   circle: circle,
                   households: selected["households identified"],
                   pattas: selected["pattas distributed"],
                   women: selected["pattas with women"]
               }
           }

            var blocksInDistrict = allInFraDistrict.map(function(value){
               var takeBlocks = R.map(R.prop('block'))
               var defaultToList = R.defaultTo([])
               var uniqueBlocks = R.compose(R.uniq, takeBlocks)
               List["blocks"].items = uniqueBlocks(value)
               return uniqueBlocks(value)
           })

            var blockData = function(block){
               var district = allInFraDistrict()
               console.log(district)
               var selected = R.find(isInBlock(block), district)
               console.log(selected)
               return {
                   block: block,
                   submitted: selected["claims submitted"],
                   settled: selected["claims settled"],
               }
           }
        

           var byteEncode = function(text){
            encoder = new TextEncoder()
            return encoder.encode(text)
            }
            var cleanup = {}
            cleanup["revenue"] = function(data){
                var cleaned = data.map(function(item){
                    return {                    
                        "District": item.district,
                        "Tahasil": item.tahasil,
                        "Circle": item.circle,
                        "Households Identified": item["households identified"],
                        "Pattas Distributed": item["pattas distributed"],
                        "Women-Inclusive Pattas": item["pattas with women"]
                    }
                })
                return cleaned;
            }
            cleanup["fra"] = function(data){
                var cleaned = data.map(function(item){
                    return {                    
                        "District": item.district,
                        "Block": item.tahasil,
                        "Claims Submitted": item["claims submitted"],
                        "Claims Settled": item["claims settled"]
                    }
                })
                return cleaned;
            }
            var makeCsv = function(data, option){

                //filter data
                 var cleaned = cleanup[option](data)
                 var csv = Papa.unparse(cleaned)
               
                var reader = new FileReader();
                var textFile = null
                var data = new Blob([byteEncode(csv)], {type: "text/csv"});

                // If we are replacing a previously generated file we need to
                // manually revoke the object URL to avoid memory leaks.
                if (textFile !== null) {
                window.URL.revokeObjectURL(textFile);
                }

                textFile = window.URL.createObjectURL(data);
                return textFile;
            }
           
            var reporting = firebase.database().ref('/')
         

            reporting.on('value',function(snapshot){
           
                rawRevenueData(snapshot.val()['revenue-reporting'])
                rawFraData(snapshot.val()['fra-reporting'])
                m.route(document.body, "/",
                {
                "/:district/:tahasil":{
                    onmatch: function(args, requestedPath){
                        var district = classUnsafe(args.district)
                        var tahasil = classUnsafe(args.tahasil)
                        selectedDistrict(district)
                        selectedTahasil(tahasil)
                        m.redraw()
                        return {type: "revenue", geography: "tahasil", name: tahasil}
                        
                    },
                    render: function(){
                        var routekey = m.route.param("district")+"/"+m.route.param("tahasil")
                        if(m.route != this.route){scrollTo(0, 0)};
                        
                        return m(Template, {banner: "tahasil", list: ["circles"], key:routekey})
                    }
                },
                "/:district":{
                    onmatch: function(args, requestedPath){
                        var district = classUnsafe(args.district)
                        selectedDistrict(district)
                        m.redraw()
                        return {type: "revenue", geography: "district", name: district}
                    },
                    render: function(){
                        var routekey = m.route.param("district")+"/"+m.route.param("tahasil")
                        if(m.route != this.route){scrollTo(0, 0)};
                        return m(Template, {banner: "district", list: ["tahasils", "blocks"], key: routekey})
                    }
                },
                "/": {
                    onmatch: function(args, requestedPath){
                        selectedDistrict("")
                        selectedTahasil("")
                        m.redraw()
                    },
                    render: function(){return m(Template, {banner: "state", list: ["districts", "fra_districts"]})}
                
                }
  
              })
                m.redraw()

            });


           
          var Template = {
                 oninit: function(vnode) {
                    Template.banner = vnode.attrs.banner
                    Template.list = vnode.attrs.list 
                },
                onupdate: function(vnode) {
                    Template.banner = vnode.attrs.banner
                    Template.list = vnode.attrs.list 
                }
          };
          Template.view = function(vnode){
              return [
                m(Banner[Template.banner], {key: Template.routekey}),
                Template.list.map(function(item){
                    return m(List[item], {key: Template.routekey})
                })
                
              ]
          }

            var Banner = {
                
            };

            Banner["state"]={
                data: {},
                fra:{},
                oninit: function(vnode){
                  Banner["state"].data = stateData
                  Banner["state"].fra = stateFraData
                }

            }

            Banner["state"].view = function(vnode){
              let handicap = {pattas: 36061, households: 30783}
              var intermediate = Setup["overallProgress"]({pattas: Banner["state"].data().pattas+Banner["state"].fra().settled-handicap.pattas, households:Banner["state"].data().households+Banner["state"].fra().submitted-handicap.households});
              var override = vnode.attrs.override || {}
              let softData=listRevenueData()
              let fraData =listFraData()
             // let fra = R.defaultTo(Banner["state"].fra(), {submitted: 0, settled:0})
              //console.log(Banner["state"].fra())
              var stats = [{label: "titles distributed", data: Banner["state"].data().pattas+Banner["state"].fra().settled-handicap.pattas, width:".w-25"}, {label: "titles pending", data: Banner["state"].data().households+Banner["state"].fra().submitted-handicap.pattas, width:".w-25"}, {label: "women-inclusive pattas", data: Banner["state"].data().women, width:".w-25"}, {label: "goal", data: 85000, width:".w-25"}]
                return [
                    m("header.bg-navy.sans-serif.white", [
                        m("div.center.tc.pa4.ph7-l",[
                            m("h1.center.f2.f1-m.f-headline-l.measure-narrow.lh-title.mv0", "ALL DISTRICTS"),
                            m("a.center.white.f6.measure-narrow.mv0",{download: "revenue.csv", href: makeCsv(softData, "revenue")}, "Export Revenue Data"),
                            m("br", " "),
                            m("a.center.white.f6.measure-narrow.mv0",{download: "fra.csv", href: makeCsv(fraData, "fra")}, "Export FRA Data"),
                            m("div.cf.pa2.center",[
                                m(barChart, barChart.chart(intermediate, override)),
                                m(Stats["all"], {stats: stats})
                                
                            ])
                    ])
                ])
            ]
            }

            Banner["district"]={
                pattas: totalPattas,
                women: totalWomenPattas,
                households: totalHouseholds, 
                submitted: totalSubmitted,
                settled: totalSettled,
                //csv: makeCsv(allInDistrict())
            };

           Banner["district"].view = function(){
                let softData = allInDistrict()
                let fraData =allInFraDistrict()
                return [
                    m("header.bg-navy.sans-serif.white", [
                        m("div.center.tc.pa4.ph7-l",[
                            m("h1.center.f1.measure-narrow.lh-title.mv0", R.toUpper(selectedDistrict())),
                            R.isEmpty(softData) ? "" : m("a.db.center.white.f6.measure-narrow.mv0",{download: "revenue.csv", href: makeCsv(softData, "revenue")}, "Export Data"),
                            m("br", " "),
                           R.isEmpty(fraData) ? "" : m("a.db.center.white.f6.measure-narrow.mv0",{download: "fra.csv", href: makeCsv(fraData, "fra")}, "Export FRA Data"),
                            m("div.cf.pa2.mh2.dib.v-mid.w-third",[
                            m(Card,
                                {
                                    type: "householdsPattas",
                                    data: {pattas: Banner["district"].pattas, households: Banner["district"].households, palette:["#001b44",progressPalette((Banner["district"].pattas/(Banner["district"].households)))]},
                                    stats: [{label: "pattas distributed", data: Banner["district"].pattas()}, {label: "households identified", data: Banner["district"].households()}, {label:"women-inclusive pattas", data: Banner["district"].women()}],
                                    override: {stroke: "#f6fffe"}
                                
                                }
                            )]),
                          (Banner["district"].submitted > 0 || Banner["district"].settled > 0) ? m("div.cf.pa2.mh2.dib.v-mid.w-third",[m(Card,
                              {
                                    type: "fraClaims",
                                    data: {settled: Banner["district"].settled, submitted: Banner["district"].submitted, palette:["#001b44",progressPalette((Banner["district"].settled/(Banner["district"].submitted)))]},
                                    stats: [{label: "claims settled", data: Banner["district"].settled()}, {label: "claims submitted", data: Banner["district"].submitted()}],
                                    override: {stroke: "#f6fffe"}
                                
                                } 
                          )]) : ""
                           /* m(Card, {
                                    type: "genderPatta", 
                                    data: {women: Banner["district"].women, pattas: Banner["district"].pattas, palette: ["#001b44","#96ccff"]}, 
                                    stats:[{label:"women-inclusive pattas", data: Banner["district"].women()}],
                                    override: {stroke: "#f6fffe"}
                            }),*/
                            ])
                        
                    ])
                ]
           }

           Banner["tahasil"] = {
               oninit: function(vnode){
                  Banner["tahasil"].data = tahasilData(selectedTahasil())
               },
               view: function(vnode){
                   let softData = allInTahasil()
                  return [
                    m("header.bg-navy.sans-serif.white", [
                        m("div.center.tc.pa4.ph7-l",[
                            m("h1.center.f2.f1-m.f-headline-l.measure-narrow.lh-title.mv0", R.toUpper(selectedTahasil())),
                            m("a.center.f4.white.link.underline-hover", {href:"/"+classSafe(selectedDistrict()) ,oncreate: m.route.link, onupdate: m.route.link}, R.toUpper(selectedDistrict())+" DISTRICT"),
                            m("br"),
                            m("a.center.white.f6.measure-narrow.mv0",{download: "data.csv", href: makeCsv(softData, "revenue")}, "Export Data"),

                            m("div.cf.pa2.center",[
                            m(Card,
                                {
                                    type: "householdsPattas",
                                    data: {pattas: Banner["tahasil"].data.pattas, households: Banner["tahasil"].data.households, palette:["#001b44",progressPalette((Banner["tahasil"].data.pattas/(Banner["tahasil"].data.households)))]},
                                    stats: [{label: "pattas distributed", data: Banner["tahasil"].data.pattas}, {label: "households identified", data: Banner["tahasil"].data.households}],
                                    override: {stroke: "#f6fffe"}
                                
                                }
                            )
                          /*  m(Card, {
                                    type: "genderPatta", 
                                    data: {women: Banner["tahasil"].data.women, pattas: Banner["tahasil"].data.pattas, palette: ["#001b44","#96ccff"]}, 
                                    stats:[{label:"women-inclusive pattas", data: Banner["tahasil"].data.women}],
                                    override: {stroke: "#f6fffe"}
                            }),*/
                            ])
                        ])
                    ])
                ]
               }
           }


           ///Tahasils
           var List = {};
           List["districts"]= {
                items: [],
           }
           List["districts"].view = function(){
               return m("article.fl.dib.w-100.cf.bg-washed-blue#districts", [m("h1.center.tc.f1.f2-m.measure-narrow.lh-title.mt4.mb0.navy","Revenue"), List["districts"].items.map(
                   function(item){
                       return m(Single["district"], {district: item, data: districtData(item)})
                    }
                )]) 
            }

            List["fra_districts"]={
                items: [],
            }
            List["fra_districts"].view = function(){
               return m("article.fl.dib.w-100.cf.bg-washed-blue#fra_districts",[m("h1.center.tc.f1.f2-m.measure-narrow.lh-title.mt4.mb0.navy","FRA Claims"),  List["fra_districts"].items.map(
                   function(item){
                       return m(Single["fra_district"], {district: item, data: fraDistrictData(item)})
                    }
                )]) 
            }

           List["tahasils"]= {
                items: [],
           }
           List["tahasils"].view = function(){
              if (!R.isEmpty(List["tahasils"].items))
              { return m("article.fl.dib.w-100.cf.bg-washed-blue#tahasils",[m("h1.center.tc.f1.f2-m.measure-narrow.lh-title.mt4.mb0.navy","Revenue") ,List["tahasils"].items.map(
                   function(item){
                       return m(Single["tahasil"], {tahasil: item, data: tahasilData(item)})
                    }
                )])} 
            }

           List["circles"]= {
                items: [],
           }
           List["circles"].view = function(){
               return m("article.fl.dib.w-100.cf.bg-washed-blue#circles", List["circles"].items.map(
                   function(item){
                       return m(Single["circle"], {key: item, circle: item, data: circleData(item)})
                    }
                )) 
            }

           List["blocks"]= {
                items: [],
           }
           List["blocks"].view = function(){
               if (!R.isEmpty(List["blocks"].items)){
               return m("article.fl.dib.w-100.cf.bg-washed-blue#blocks", [m("h1.center.tc.f1.f2-m.measure-narrow.lh-title.mt4.mb0.navy","FRA Claims") ,List["blocks"].items.map(
                   function(item){
                       return m(Single["block"], {key: item, block: item, data: blockData(item)})
                    }
                )]) }
            }

            var percentageText = function(patta,household){
               if (patta/household>=.8){
                   console.log(patta/household)
                   return "fill:#000"
               } else{
                   console.log(patta/household)
                   return "fill: #ff4136"
               }
           }

            var statColor = function(women,pattas){
               if (women/pattas>=.8){
                   console.log(women/pattas)
                   return ""
               } else{
                   console.log(women/pattas)
                   return "red"
               }
           }

            var Single={}
            Single["district"] = {
                
            }
        
            Single["tahasil"] = {
               contact: "",
               oninit: function(vnode){
                    firebase.database().ref('/tahasildar-contacts/'+firebaseSafe(selectedDistrict())+"*"+firebaseSafe(vnode.attrs.tahasil)).once('value').then(function(snapshot){
                        vnode.state.contact = snapshot.val().name + " (" +snapshot.val().mobile+ ")"
                        m.redraw()
                    });
               },
            }
            Single["district"].view = function(vnode){
                return m('div.tahasil.cf.h5.fl.w-100.w-50-m.w-25-ns.mv3.tc', [ m('div.tahasil-container.fl.w-100',[
                    m("h1.tc.f4.mv2", [m("a.navy",{href:"/"+classSafe(vnode.attrs.district),oncreate: m.route.link, onupdate: m.route.link},R.toUpper(vnode.attrs.district))]),
                    m("div.cf.pa1.center",[
                        m(Card,{
                            type: "householdsPattas",
                            data: vnode.attrs.data,
                            stats: [{label: "pattas distributed", data: vnode.attrs.data["pattas"]}, {label: "households identified", data: vnode.attrs.data["households"]},{label: "women-inclusive pattas", data: vnode.attrs.data["women"], color:statColor(vnode.attrs.data["women"],vnode.attrs.data["pattas"])}],
                            override: {width: 250, style: percentageText(vnode.attrs.data["pattas"],vnode.attrs.data["households"])}
                        }),
                        /* m(Card,{
                            type: "genderPatta",
                            data: vnode.attrs.data,
                            stats: [{label: "women-inclusive pattas", data: vnode.attrs.data["women"]}],
                            override: {width: 250, style: "fill:#000"}
                        })*/
                    ])
                    
                    ])
                    ])
           }
              Single["fra_district"]={}
              Single["fra_district"].view = function(vnode){
                return m('div.district.cf.h5.fl.w-100.w-50-m.w-25-ns.mv3.tc', [ m('div.district-container.fl.w-100',[
                    m("h1.tc.f4.mv2", [m("a.navy",{href:"/"+classSafe(vnode.attrs.district),oncreate: m.route.link, onupdate: m.route.link},R.toUpper(vnode.attrs.district))]),
                    m("div.cf.pa1.center",[
                        m(Card,{
                            type: "fraClaims",
                            data: vnode.attrs.data,
                            stats: [{label: "claims settled", data: vnode.attrs.data["settled"]}, {label: "claims submitted", data: vnode.attrs.data["submitted"]}],
                            override: {width: 250, style: percentageText(vnode.attrs.data["settled"],vnode.attrs.data["submitted"])}
                        }),
                        /* m(Card,{
                            type: "genderPatta",
                            data: vnode.attrs.data,
                            stats: [{label: "women-inclusive pattas", data: vnode.attrs.data["women"]}],
                            override: {width: 250, style: "fill:#000"}
                        })*/
                    ])
                    
                    ])
                    ])
           }

     

            Single["tahasil"].view = function(vnode){
            
                return m('div.tahasil.cf.h5.fl.w-100.w-50-m.w-25-ns.mv3.tc', [ m('div.tahasil-container.fl.w-100',[
                    m("h1.tc.f4.mv2", [m("a.navy",{href:"/"+classSafe(selectedDistrict())+"/"+classSafe(vnode.attrs.tahasil),oncreate: m.route.link, onupdate: m.route.link},R.toUpper(vnode.attrs.tahasil))]),
                    m("h4.tc.f6.mv1", (vnode.state.contact || "contact not found")),
                    m("div.cf.pa1.center",[
                        m(Card,{
                            type: "householdsPattas",
                            data: vnode.attrs.data,
                            stats: [{label: "pattas distributed", data: vnode.attrs.data["pattas"]}, {label: "households identified", data: vnode.attrs.data["households"]},{label: "women-inclusive pattas", data: vnode.attrs.data["women"], color:statColor(vnode.attrs.data["women"],vnode.attrs.data["pattas"])}],
                            override: {width: 125, style: percentageText(vnode.attrs.data["pattas"],vnode.attrs.data["households"])}
                        }),
                        /* m(Card,{
                            type: "genderPatta",
                            data: vnode.attrs.data,
                            stats: [{label: "women-inclusive pattas", data: vnode.attrs.data["women"]}],
                            override: {width: 250, style: "fill:#000"}
                        })*/
                    ])
                    
                    ])
                    ])
           }


           Single["circle"] = {
               contact: "",
               oninit: function(vnode){
                    firebase.database().ref('/ri-contacts/'+firebaseSafe(selectedDistrict())+"*"+firebaseSafe(selectedTahasil())+"*"+firebaseSafe(vnode.attrs.circle)).once('value').then(function(snapshot){
                        vnode.state.contact = snapshot.val().name + " (" +snapshot.val().mobile+ ")"
                        m.redraw()
                    });
               },
           }
           Single["circle"].view = function(vnode){
                return m('div.tahasil.cf.h5.fl.w-100.w-50-m.w-25-ns.mv3.tc', [ m('div.tahasil-container.fl.w-100',[
                    m("h1.tc.f4.mv2", [m("a.navy",R.toUpper(vnode.attrs.circle))]),
                    m("h4.tc.f6.mv1", (vnode.state.contact || "contact not found")),
                    m("div.cf.pa1.center",[
                        m(Card,{
                            type: "householdsPattas",
                            data: vnode.attrs.data,
                            stats: [{label: "pattas distributed", data: vnode.attrs.data["pattas"]}, {label: "households identified", data: vnode.attrs.data["households"]},{label: "women-inclusive pattas", data: vnode.attrs.data["women"], color:statColor(vnode.attrs.data["women"],vnode.attrs.data["pattas"])}],
                            override: {width: 250, style: percentageText(vnode.attrs.data["pattas"],vnode.attrs.data["households"])}
                        }),
                       /*  m(Card,{
                            type: "genderPatta",
                            data: vnode.attrs.data,
                            stats: [{label: "women-inclusive pattas", data: vnode.attrs.data["women"]}],
                            override: {width: 250, style: "fill:#000"}
                        })*/
                    ])
                    
                    ])
                    ])
           }

           Single["block"] = {
               contact: "",
               oninit: function(vnode){
                    firebase.database().ref('/weo-contacts/'+firebaseSafe(selectedDistrict())+"*"+firebaseSafe(vnode.attrs.block)).once('value').then(function(snapshot){
                        vnode.state.contact = snapshot.val().name + " (" +snapshot.val().mobile+ ")"
                        m.redraw()
                    });
               },
           }
           Single["block"].view = function(vnode){
                return m('div.tahasil.cf.h5.fl.w-100.w-50-m.w-25-ns.mv3.tc', [ m('div.tahasil-container.fl.w-100',[
                    m("h1.tc.f4.mv2", [m("a.navy",R.toUpper(vnode.attrs.block))]),
                    m("h4.tc.f6.mv1", (vnode.state.contact || "contact not found")),
                    m("div.cf.pa1.center",[
                        m(Card,{
                            type: "fraClaims",
                            data: vnode.attrs.data,
                            stats: [{label: "claims settled", data: vnode.attrs.data["settled"]}, {label: "claims submitted", data: vnode.attrs.data["submitted"]}],
                            override: {width: 250, style: percentageText(vnode.attrs.data["settled"],vnode.attrs.data["submitted"])}
                        }),
                    ])
                    
                    ])
                    ])
           }
           
           /// pieChart Template

    var pieChart = {};    
    pieChart.chart = function(args, override){
        return {pie: Paths.Pie({
                    data: args.data,
                    accessor: function(x) { return x.amount },
                    compute: {
                        color: function(i) { return args.palette[i]; }
                    },
                    center: [61.5, 51],
                    r: 50,
                    R: 35,  
                }),
                label: args.label,
                override: override || {}
                }
    }
   
    pieChart.view = function(vnode) {
        return [
            m('div.fl.w-50.v-mid',[
            m('svg.center.tc', {
            width: vnode.attrs.override.width || "100%",
            height: vnode.attrs.override.height || /*204*/102
            }, [
            vnode.attrs.pie.curves.map(function(d, i) {
                return [
                m('path', {
                    d: d.sector.path.print(),
                    style: 'fill:' + d.color,
                    stroke: vnode.attrs.override.stroke || '#001b44',
                    "stroke-width": 2,
                   
                }),
                m('text',{
                    x:vnode.attrs.override.textX || 61.5,
                    y:vnode.attrs.override.textY || 55,
                    "font-size":15,
                    'text-anchor': 'middle',
                    style: vnode.attrs.override.style || "fill:#fff",
                }, vnode.attrs.label)
                ]
            })
            ])
            ])   
        ]

    }

    var barChart = {}
    barChart.chart = function(args, override){
        return {
            bar: Paths.Stack({
            data: args.data,
            accessor: function(item) { return item.amount },
            compute: {
                color: function(i, item) { return item.color; }
            },
            width: 100,
            height: 600,
            gutter: 0,
            offset: [0, 0]
        }),
        label: args.label || "",
        override: override || {}
        }
    }

    barChart.view = function(vnode){
        return [
            m('svg.center', {
            width: vnode.attrs.override.width || 600,
            height: vnode.attrs.override.height || 100,
            transform: ""
            }, [
            m('g',{transform:"rotate(270 50 50)"}, [
                vnode.attrs.bar.curves.map(function(d, i) {
                return [
                    m('path', {
                    d: d.line.path.print(),
                    style: 'fill:' + d.color,
                    stroke: vnode.attrs.override.stroke || '#e8fdf5',
                    "stroke-width": 2,
                    })
                    /*,m('text',{
                        'text-anchor': 'middle',
                        transform: 'rotate(-270 50 50)',
                        x: d.line.centroid[1],
                        y: 50,
                        style:"fill:#ffffff"
                    }, d.item.amount),
                    m('text',{
                        'text-anchor': 'middle',
                        transform: 'rotate(-270 50 50)',
                        x: d.line.centroid[1],
                        y: 110,
                        style:"fill:#ffffff; width:50px"
                    }, d.item.name)*/ 
                    ]
                })
            ])
            ])
        ]
    }



///// Mithril Views 
          
            var Setup = {}
            Setup["genderPatta"] = function(input){
                var women = parseInt(JSON.stringify(input.women));
                var pattas = parseInt(JSON.stringify(input.pattas))-women;
                var data = [
                    {
                    name: "men-only pattas",
                    amount: Math.max(pattas, 0.00001)
                },
                {
                    name: "women-inclusive pattas",
                    amount: Math.max(women, 0.00001)
                },
                ]
                var palette = input.palette ||["#f6fffe","#96ccff"]
                var label = ((women/(pattas+women)*100).toFixed(1).toString()+'%')
                return {data: data, palette: palette, label: label}

           }

            Setup["householdsPattas"] = function(input){
                var pattas = parseInt(JSON.stringify(input.pattas));
                var households = parseInt(JSON.stringify(input.households))-pattas;
                var data = [
                    {
                    name: "households identified",
                    amount: Math.max(households-.01, 0.01)
                },
                {
                    name: "pattas distributed",
                    amount: Math.max(pattas, 0.01)
                },
                ]
                var palette = input.palette || ["#f6fffe", progressPalette((pattas/(pattas+households)))]
                var label = ((pattas/(pattas+households)*100).toFixed(1).toString()+'%')
                return {data: data, palette: palette, label: label}

           }

            Setup["fraClaims"] = function(input){
                var settled = parseInt(JSON.stringify(input.settled));
                var submitted = parseInt(JSON.stringify(input.submitted))-settled;
                var data = [
                    {
                    name: "claims submitted",
                    amount: Math.max(submitted-.01, 0.01)
                },
                {
                    name: "claims settled",
                    amount: Math.max(settled, 0.01)
                },
                ]
                var palette = input.palette || ["#f6fffe", progressPalette((settled/(settled+submitted)))]
                var label = ((settled/(settled+submitted)*100).toFixed(1).toString()+'%')
                return {data: data, palette: palette, label: label}

           }

           Setup["overallProgress"] = function(input){
                var pattas = parseInt(JSON.stringify(input.pattas));
                var households = parseInt(JSON.stringify(input.households))-pattas;
                var data = [[
                    {
                    name: "remaining",
                    amount: 85000-households-pattas,
                    color: "#001b44"
                    }],
                    [
                    {
                    name: "households",
                    amount: Math.max(households, 0.01),
                    color: "#e8fdf5"
                    }],[
                    {
                        name: "pattas",
                        amount: Math.max(pattas, 0.01),
                        color: "#19a974"
                    },
                ]]
                var palette = input.palette || ["#f6fffe", progressPalette((pattas/(pattas+households)))]
                var label = ""
                return {data: data, palette: palette, label: label}
           }
          
          var progressPalette = function(input){
              var scale = chroma.scale(['e7040f', 'ffde37', '19a974']);
              return scale(input);
          }

           var Stats = {}
           Stats.view = function(vnode){
               return m('article.pa0.fl.w-50',vnode.attrs.stats.map(function(stat){return m(Stat, stat)}))
           }
        
          var Stat = {};
          Stat.view = function(vnode){
             var color = vnode.attrs.color || ""
             /* var width = vnode.attrs.width || ".w-third"*/
              return m("div.tl.dib.w-100.pl1",[
                            m("div.fl.w-100.dib-l.w-auto-l.lh-title",[
                                m("span.f6.fw6.ml0"+"."+color, vnode.attrs.data),
                                 m("span.f7.fw4.ml0", " "+vnode.attrs.label)
                            ])
                        ])

          }

          var Card = {}

          Card.view = function(vnode){
              var intermediate = Setup[vnode.attrs.type](vnode.attrs.data);
              var override = vnode.attrs.override || {}
              return m("article.mw5.cf.mw5-m.dib.br3.pa2.pa1-ns.mv1.h-auto.ba", [
                  (vnode.attrs.header ? vnode.attrs.header : ""),
                  m("div.tc.pt2", [
                            m(pieChart, pieChart.chart(intermediate, override)),
                            m(Stats, vnode.attrs)])
                  ])
          }

           var Dash = {}
           
           Stats["all"] = {}
           Stats["all"].view = function(vnode){
               return m('article.pa1.pa2-ns',vnode.attrs.stats.map(function(stat){return m(Stat["all"], stat)}))
           }
        
          Stat["all"] = {};
          Stat["all"].view = function(vnode){
              var width = vnode.attrs.width || ".w-25"
              return m("div.tc.dib"+width,[
                            m("dl.dib",[
                                m("dd.tc.f6.fw4.ma1", vnode.attrs.label),
                                m("dd.tc.f2.f-subheadline-1.fw6.ma1", vnode.attrs.data)
                            ])
                        ])
                
          }

        

        </script>
  </body>

</html>
